{
	"$schema": "https://vega.github.io/schema/vega/v5.json",
	"padding": 0,
	"width": 600,
	"height": 500,

	"title": {
		"text": "Simulated percentage time in lockdown",
		"subtitle": "Percentage time in lockdown, disaggregated by level of restrictions, by month.",
		"frame":"group",
		"dx": -10
	},
  
	"data": [
		{
			"name": "selected",
			"values": [
				{ "value": "1" },
				{ "value": "1b" },
				{ "value": "2" },
				{ "value": "3" },
				{ "value": "4" }
			],
			"on": [
				{"trigger": "clicked", "toggle": "clicked"}
			]
		},
		{
			"name": "main",
			"format": {"type": "csv", "parse": "auto"},
			"url": "/posts/pandemic-trade-offs-july-2021/data-lockdown.csv",
			"transform": [
				{ "type": "filter", "expr": "datum.Policy === Strategy" },
				{ "type": "filter", "expr": "datum.VacUptake === VaccineUptake" },
				{ "type": "filter", "expr": "datum.IncurRate === VaccArrivals" },
				{ "type": "filter", "expr": "datum.Kids === VaccKids" },
				{ "type": "filter", "expr": "datum.R0 === R0" },
				{ "type": "filter", "expr": "datum.TracePower === 'ass100_90at5'" },
				{ "type": "stack", "groupby": ["day"], "sort": {"field": "stage", "order": "descending"}, "field": "stage_prop" }
			]
		},
		{
			"name": "mainByWeek",
			"source": "main",
			"transform": [
				{ "type": "formula", "as": "label", "expr": "toString(datum.stage_prop) + '%'" },
				{ "type": "formula", "as": "group", "expr": "'group'" },
				{ "type": "pivot", "groupby": ["day"], "field": "group", "value": "lab", "op": "values" },
				{ "type": "formula", "as": "1", "expr": "datum.group[0].label" },
				{ "type": "formula", "as": "1b", "expr": "datum.group[1].label" },
				{ "type": "formula", "as": "2", "expr": "datum.group[2].label" },
				{ "type": "formula", "as": "3", "expr": "datum.group[3].label" },
				{ "type": "formula", "as": "4", "expr": "datum.group[4].label" }
			]
		}
	],

	"uom": {
		"minWidth": 900,
		"figPosition": "outset-3",
		"increaseMargin": 2,
		"dataDownload": {
			"href": "/posts/pandemic-trade-offs/data-ABM-aggregated-tidy-v2.csv",
			"size": "Currently unavailable"
		},
		"toggleGroups": [
			{
				"name": "None",
				"toggles": [
					{
						"title": "Vaccine Uptake",
						"description": "Percentage of people who accept vaccination when they are offered it.",
						"detailLink": "/pandemic-trade-offs-detail-july-2021/",
						"type": "select",
						"options": [
							{ "value": 0.7, "label": "70%", "default": true },
							{ "value": 0.8, "label": "80%" },
							{ "value": 0.9, "label": "90%" },
							{ "value": 0.95, "label": "95%" }
						],
						"signalName": "VaccineUptake"
					},
					{
						"title": "Strategy",
						"description": "Short, medium, and long term strategies employed to mitigate the spread of COVID-19 <br> (< 6 mths / 6-12 mths / 12+ mths)",
						"detailLink": "/pandemic-trade-offs-detail-july-2021/#strategies",
						"type": "select",
						"options": [
							{ "value": "ME_ME_TS", "label": "Elimination / Elimination / Tight", "default": true },
							{ "value": "ME_TS_LS", "label": "Elimination / Tight / Loose" },
							{ "value": "ME_TS_BS", "label": "Elimination / Tight / Barely Suppress" }
						],
						"signalName": "Strategy"
					},
					{
						"title": "Vaccinated Infected Arrivals per day",
						"description": "Average number of vaccinated yet infected people arriving in Australia per day, after borders open",
						"detailLink": "/pandemic-trade-offs-detail-july-2021/#arrivals",
						"type": "select",
						"options": [
							{ "value": 0.2, "label": "0.2 per day", "default": true },
							{ "value": 1.0, "label": "1 per day" },
							{ "value": 5.0, "label": "5 per day" }
						],
						"signalName": "VaccArrivals"
					},
					{
						"title": "Vaccinate Children",
						"description": "Whether children are vaccinated alongside adults",
						"detailLink": "/pandemic-trade-offs-detail-july-2021/#effectiveness",
						"type": "select",
						"options": [
							{ "value": "No", "label": "No"},
							{ "value": "Yes", "label": "Yes", "default": true }
						],
						"signalName": "VaccKids"
					},
					{
						"title": "Virus Reproduction Rate (R0)",
						"description": "Average number of people each infected person infects with no interventions, such as masks, physical distancing, case isolation, and vaccination.",
						"detailLink": "/pandemic-trade-offs-detail-july-2021/#reproduction",
						"type": "select",
						"options": [
							{ "value": 5.0, "label": "5.0", "default": true },
							{ "value": 6.5, "label": "6.5" },
							{ "value": 8.0, "label": "8.0" }
						],
						"signalName": "R0"
					}
				]
			}
		]
	},

	"signals": [
		{
			"name": "clicked", "value": null,
			"on": [
				{
					"events": "@legendSymbol:click, @legendLabel:click",
					"update": "{value: datum.value}",
					"force":  true
				}
			]
		},

		{
			"name": "hasChanged",
			"init": false,
			"on": [
				{ "events": { "signal": "clicked" }, "update": "true" }
			]
		}
	],
  
	"scales": [
		{
			"name": "x",
			"type": "band",
			"range": "width",
			"domain": {"data": "main", "field": "day"}
		},
		{
			"name": "y",
			"type": "linear",
			"range": "height",
			"nice": true, "zero": true,
			"domain": [0,100]
		},
		{
			"name": "colour",
			"type": "ordinal",
			"range": {"scheme": "yelloworangered"},
			"reverse":true,
			"range": ["#41af4c", "#75c23c", "#eed23a", "#d99141", "#e34545"],
			"reverse":false,
			"domain": {"data": "main", "field": "stage"}
		},
		{
			"name": "parameters",
			"type": "ordinal",
			"domain": { "signal": "['Strategy: ' + Strategy, 'Infected_arrivals: ' + VaccArrivals, 'Vaccinate_kids: ' + VaccKids, 'R_0: ' + R0]"},
			"range": ["#ffffff", "#ffffff", "#ffffff", "#ffffff", "#ffffff"]
		}
	],
  
	"axes": [
	  	{
			"orient": "bottom", 
			"scale": "x", 
			"values": [0,10,20,30,40,50,60,70,80],
			"title": "Weeks since start of simulation",
			"titleY": 50,
			"zindex": 100
		},
	  	{
			"orient": "left", 
			"scale": "y", 
			"title": "Percentage time in lockdown",
			"titleX": -50,
			"zindex": 100
		}
	],

	"legends": [
		{
			"fill": "colour",
			"labelLimit": 200,
			"title": "Stages",
			"orient":"bottom",
			"encode": {
				"symbols": {
					"name": "legendSymbol",
					"interactive": false,
					"update": {
						"opacity": [
							{"test": "indata('selected', 'value', datum.value)", "value": 1},
							{"value": 0.15}
						],
						"cursor": {"value": "pointer"}
					}
				},
				"labels": {
					"name": "legendLabel",
					"interactive": false,
					"update": {
						"opacity": [
							{"test": "indata('selected', 'value', datum.value)", "value": 1},
							{"value": 0.25}
						],
						"cursor": {"value": "pointer"}
					}
				}
			}
		},
		{
			"fill": "parameters",
			"labelLimit": 200,
			"title": "Parameters",
			"orient":"bottom",
			"titleFontSize": 18,
			"titlePadding": 10,
			"symbolSize": 0,
			"rowPadding": 3,
			"padding": 15,
			"fillColor": "#f2f5f9",
			"cornerRadius": 5,
			"encode": {
				"labels": {
					"enter": {
						"dx": {"value": -24},
						"fontSize": {"value": 14},
						"font": {"value": "monospace"}
					}
				}
			}
		}
	],
  
	"marks": [
		{
			"type": "rect",
			"from": {"data": "main"},
			"encode": {
				"enter": {
					"x": {"scale": "x", "field": "day"},
					"width": {"scale": "x", "band": 1, "offset": -1},
					"y": {"scale": "y", "field": "y0"},
					"y2": {"scale": "y", "field": "y1"},
					"fill": {"scale": "colour", "field": "stage"},
					"tooltip": { "signal": "{ 'title': datum.day, 'Restriction prevalence': datum.stage_prop + '% (Stage ' + datum.stage + ')' }"}
				},
				"update": {
					"fillOpacity": {"value": 1}
				},
				"hover": {
					"fillOpacity": {"value": 0.5}
				}
			}
		},
		{
			"type": "rect",
			"from": { "data": "mainByWeek" },
			"encode": {
				"update": {
					"x": {"scale": "x", "signal": "datum.day"},
					"width": {"scale": "x", "band": 1, "offset": -1},
					"y": {"scale": "y", "value": 0},
					"y2": {"signal": "range('y')[1]"},
					"strokeWidth": {"value": 0},
					"fill": {"value": "#fff"},
					"fillOpacity": {"value": 0},
					"tooltip": { "signal": "{ 'title': 'Week ' + datum.day, 'Stage 1': datum['1'], 'Stage 1b': datum['1b'], 'Stage 2': datum['2'], 'Stage 3': datum['3'], 'Stage 4': datum['4']}"}
				},
				"hover": {
					"fillOpacity": {"value": 0.5}
				}
			}
		}
	]
}