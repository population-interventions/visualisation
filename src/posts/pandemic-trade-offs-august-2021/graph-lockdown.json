{
	"$schema": "https://vega.github.io/schema/vega/v5.json",
	"padding": 0,
	"width": 600,
	"height": 500,

	"title": {
		"text": "Simulated probability of lockdown",
		"subtitle": "Probability of society being in each level of lockdown, by week of simulation.",
		"frame":"group",
		"dx": -10
	},
  
	"data": [
		{
			"name": "selected",
			"values": [
				{ "value": "1" },
				{ "value": "1b" },
				{ "value": "2" },
				{ "value": "3" },
				{ "value": "4" }
			],
			"on": [
				{"trigger": "clicked", "toggle": "clicked"}
			]
		},
		{
			"name": "main",
			"format": {"type": "csv", "parse": "auto"},
			"url": "/posts/pandemic-trade-offs-august-2021/data-lockdown.csv",
			"transform": [
				{ "type": "filter", "expr": "datum.Policy === Strategy" },
				{ "type": "filter", "expr": "datum.VacUptake === VaccineUptake" },
				{ "type": "filter", "expr": "datum.IncurRate === VaccArrivals" },
				{ "type": "filter", "expr": "datum.Kids === VaccKids" },
				{ "type": "filter", "expr": "datum.MinStage === MinStage" },
				{ "type": "filter", "expr": "datum.R0 === R0" },
				{ "type": "filter", "expr": "datum.TracePower === 'ass100_90at5'" },
				{ "type": "stack", "groupby": ["day"], "sort": {"field": "stage", "order": "descending"}, "field": "stage_prop" }
			]
		},
		{
			"name": "mainByWeek",
			"source": "main",
			"transform": [
				{ "type": "formula", "as": "label", "expr": "toString(datum.stage_prop) + '%'" },
				{ "type": "formula", "as": "group", "expr": "'group'" },
				{ "type": "pivot", "groupby": ["day"], "field": "group", "value": "lab", "op": "values" },
				{ "type": "formula", "as": "1", "expr": "datum.group[0].label" },
				{ "type": "formula", "as": "1b", "expr": "datum.group[1].label" },
				{ "type": "formula", "as": "2", "expr": "datum.group[2].label" },
				{ "type": "formula", "as": "3", "expr": "datum.group[3].label" },
				{ "type": "formula", "as": "4", "expr": "datum.group[4].label" }
			]
		},
		{
			"name": "rules",
			"values": [
				{ "phase": "Borders open", "startDay": 210 }
			]
		}
	],

	"uom": {
		"minWidth": 900,
		"figPosition": "outset-3",
		"increaseMargin": 2,
		"dataDownload": {
			"href": "/posts/pandemic-trade-offs/data-ABM-aggregated-tidy-v2.csv",
			"size": "Currently unavailable"
		},
		"toggleGroups": [
			{
				"name": "None",
				"toggles": [
					{
						"title": "Vaccine Uptake",
						"description": "Percentage of people who accept vaccination when they are offered it.",
						"detailLink": "/pandemic-trade-offs-detail-august-2021/",
						"type": "select",
						"options": [
							{ "value": 0.7, "label": "70%", "default": true },
							{ "value": 0.8, "label": "80%" },
							{ "value": 0.9, "label": "90%" },
							{ "value": 0.95, "label": "95%" }
						],
						"signalName": "VaccineUptake"
					},
					{
						"title": "Strategy",
						"description": "Short, medium, and long term strategies employed to mitigate the spread of COVID-19 <br> (< 4 mths / 4-8 mths / 8+ mths)",
						"detailLink": "/pandemic-trade-offs-detail-august-2021/#strategies",
						"type": "select",
						"options": [
							{ "value": "ME_ME_TS", "label": "Elimination / Elimination / Tight", "default": true },
							{ "value": "ME_TS_LS", "label": "Elimination / Tight / Loose" },
							{ "value": "ME_TS_BS", "label": "Elimination / Tight / Barely Suppress" }
						],
						"signalName": "Strategy"
					},
					{
						"title": "Vaccinated Infected Arrivals per day",
						"description": "Average number of vaccinated yet infected people arriving in Australia per day, after borders open",
						"detailLink": "/pandemic-trade-offs-detail-august-2021/#arrivals",
						"type": "select",
						"options": [
							{ "value": 0.2, "label": "0.2 per day", "default": true },
							{ "value": 1.0, "label": "1 per day" },
							{ "value": 5.0, "label": "5 per day" }
						],
						"signalName": "VaccArrivals"
					},
					{
						"title": "Vaccinate Children",
						"description": "Whether children are vaccinated alongside adults",
						"detailLink": "/pandemic-trade-offs-detail-august-2021/#effectiveness",
						"type": "select",
						"options": [
							{ "value": "No", "label": "No"},
							{ "value": "Yes", "label": "Yes", "default": true }
						],
						"signalName": "VaccKids"
					},
					{
						"title": "Minimum stage",
						"description": "The least restrictive stage of restrictions allowed in simulations",
						"detailLink": "/pandemic-trade-offs-detail-august-2021/#effectiveness",
						"type": "select",
						"options": [
							{ "value": "1a", "label": "1a"},
							{ "value": "2", "label": "2", "default": true }
						],
						"signalName": "MinStage"
					},
					{
						"title": "Virus Reproduction Rate (R0)",
						"description": "Average number of people each infected person infects with no interventions, such as masks, physical distancing, case isolation, and vaccination.",
						"detailLink": "/pandemic-trade-offs-detail-august-2021/#reproduction",
						"type": "select",
						"options": [
							{ "value": 5.0, "label": "5.0" },
							{ "value": 6.5, "label": "6.5", "default": true  },
							{ "value": 8.0, "label": "8.0" }
						],
						"signalName": "R0"
					}
				]
			}
		]
	},

	"signals": [
		{
			"name": "clicked", "value": null,
			"on": [
				{
					"events": "@legendSymbol:click, @legendLabel:click",
					"update": "{value: datum.value}",
					"force":  true
				}
			]
		},

		{
			"name": "hasChanged",
			"init": false,
			"on": [
				{ "events": { "signal": "clicked" }, "update": "true" }
			]
		}
	],
  
	"scales": [
		{
			"name": "x",
			"type": "band",
			"range": "width",
			"domain": {"data": "main", "field": "day"}
		},
		{
			"name": "y",
			"type": "linear",
			"range": "height",
			"nice": true, "zero": true,
			"domain": [0,100]
		},
		{
			"name": "colour",
			"type": "ordinal",
			"range": {"scheme": "yelloworangered"},
			"reverse":true,
			"range": ["#41af4c", "#75c23c", "#eed23a", "#d99141", "#e34545"],
			"reverse":false,
			"domain": ["1", "1b", "2", "3", "4"]
		},
		{
			"name": "parameters",
			"type": "ordinal",
			"domain": { "signal": "['Vaccine_uptake: ' + VaccineUptake, 'Strategy: ' + Strategy, 'Infected_arrivals: ' + VaccArrivals, 'Vaccinate_kids: ' + VaccKids, 'Minimum Stage: ' + MinStage, 'R_0: ' + R0]"},
			"range": ["#ffffff", "#ffffff", "#ffffff", "#ffffff", "#ffffff"]
		}
	],
  
	"axes": [
	  	{
			"orient": "bottom", 
			"scale": "x", 
			"values": [0,10,20,30,40,50,60,70,80],
			"title": "Weeks since start of simulation",
			"titleY": 50,
			"zindex": 100
		},
	  	{
			"orient": "left", 
			"scale": "y", 
			"title": "Probability of lockdown (%)",
			"titleX": -50,
			"zindex": 100
		}
	],

	"legends": [
		{
			"fill": "colour",
			"labelLimit": 200,
			"title": "Stages",
			"orient":"bottom",
			"encode": {
				"symbols": {
					"name": "legendSymbol",
					"interactive": false,
					"update": {
						"opacity": [
							{"test": "indata('selected', 'value', datum.value)", "value": 1},
							{"value": 0.15}
						],
						"cursor": {"value": "pointer"}
					}
				},
				"labels": {
					"name": "legendLabel",
					"interactive": false,
					"update": {
						"opacity": [
							{"test": "indata('selected', 'value', datum.value)", "value": 1},
							{"value": 0.25}
						],
						"cursor": {"value": "pointer"}
					}
				}
			}
		},
		{
			"fill": "parameters",
			"labelLimit": 200,
			"title": "Parameters",
			"orient":"bottom",
			"titleFontSize": 18,
			"titlePadding": 10,
			"symbolSize": 0,
			"rowPadding": 3,
			"padding": 15,
			"fillColor": "#f2f5f9",
			"cornerRadius": 5,
			"encode": {
				"labels": {
					"enter": {
						"dx": {"value": -24},
						"fontSize": {"value": 14},
						"font": {"value": "monospace"}
					}
				}
			}
		}
	],
  
	"marks": [
		{
			"type": "rect",
			"from": {"data": "main"},
			"encode": {
				"enter": {
					"x": {"scale": "x", "field": "day"},
					"width": {"scale": "x", "band": 1, "offset": -1},
					"y": {"scale": "y", "field": "y0"},
					"y2": {"scale": "y", "field": "y1"},
					"fill": {"scale": "colour", "field": "stage"},
					"tooltip": { "signal": "{ 'title': datum.day, 'Restriction prevalence': datum.stage_prop + '% (Stage ' + datum.stage + ')' }"}
				},
				"update": {
					"fillOpacity": {"value": 1}
				},
				"hover": {
					"fillOpacity": {"value": 0.5}
				}
			}
		},
		{
			"type": "rect",
			"from": { "data": "mainByWeek" },
			"encode": {
				"update": {
					"x": {"scale": "x", "signal": "datum.day"},
					"width": {"scale": "x", "band": 1, "offset": -1},
					"y": {"scale": "y", "value": 0},
					"y2": {"signal": "range('y')[1]"},
					"strokeWidth": {"value": 0},
					"fill": {"value": "#fff"},
					"fillOpacity": {"value": 0},
					"tooltip": { "signal": "{ 'title': 'Week ' + datum.day, 'Stage 1': datum['1'], 'Stage 1b': datum['1b'], 'Stage 2': datum['2'], 'Stage 3': datum['3'], 'Stage 4': datum['4']}"}
				},
				"hover": {
					"fillOpacity": {"value": 0.5}
				}
			}
		},
		{
			"type": "rule",
			"clip": true,
			"from": { "data": "rules" },
			"encode": {
				"update": {
					"x": {"scale": "x", "signal": "datum.startDay / 7"},
					"x2": {"scale": "x", "signal": "datum.startDay / 7"},
					"y": {"scale": "y", "value": 0},
					"y2": {"signal": "range('y')[1]"},
					"strokeOpacity": {"signal": "datum.startDay > 0 ? 1 : 0.1"},
					"size": {"value": 2},
					"color": {"value": "#529bff"}
				}
			}
		},
		{
			"type": "text",
			"name": "phases",
			"clip": true,
			"from": { "data": "rules" },
			"encode": {
				"update": {
					"x": {"scale": "x", "signal": "datum.startDay / 7"},
					"y": {"signal": "range('y')[1] + 3"},
					"text": {"signal": "'Borders Open'"},
					"baseline": {"value": "top"},
					"align": {"value": "left"},
					"dx": {"value": 5},
					"fill": {"value": "#012a58"},
					"href": {"value": "/pandemic-trade-offs-detail#phases"},
					"cursor": {"value": "pointer"}
				}
			},
			"zindex": 1
		},
		{
			"type": "rect",
			"from": {"data": "phases"},
			"encode": {
				"enter": {
					"x": {"field": "bounds.x1", "round": true, "offset": {"value": -3}},
					"x2": {"field": "bounds.x2", "round": true, "offset": {"value": 3}},
					"y": {"field": "bounds.y1", "round": true, "offset": {"value": -3}},
					"y2": {"field": "bounds.y2", "round": true, "offset": {"value": 3}},
					"fill": {"value": "#f0f0f0"},
					"fillOpacity": {"value": 0.8}
				}
			}
		},
		{
			"name": "timestamp",
			"type": "text",
			"encode": {
			  "enter": {
				"x": {"signal": "range('x')[1] - 3"},
				"y": {"signal": "range('y')[1] + 3"},
				"fill": {"value": "#012a58"},
				"text": {"value": "Updated: 03 Sep 2021"},
				"align": {"value": "right"},
				"baseline": {"value": "top"}
			  }
			},
			"zindex": 1
		  },
		  {
			"type": "rect",
			"from": {"data": "timestamp"},
			"encode": {
			  "enter": {
				"x": {"field": "bounds.x1", "round": true, "offset": {"value": -3}},
				"x2": {"field": "bounds.x2", "round": true, "offset": {"value": 3}},
				"y": {"field": "bounds.y1", "round": true, "offset": {"value": -3}},
				"y2": {"field": "bounds.y2", "round": true, "offset": {"value": 3}},
				"fill": {"value": "#f0f0f0"},
				"fillOpacity": {"value": 0.8}
			  }
			}
		  }
	]
}