{
	"$schema": "https://vega.github.io/schema/vega/v5.json",
	"padding": 0,
	"width": 600,
	"height": 500,

	"title": {
		"text": "Simulated COVID-19 infection numbers",
		"subtitle": "Median daily new infections and 90% uncertainty interval, by strategy.",
		"frame":"group",
		"dx": -10
	},

	"data": [
		{
			"name": "selected",
			"values": [
				{ "value": "70% Vaccinated" },
				{ "value": "80% Vaccinated" },
				{ "value": "90% Vaccinated" },
				{ "value": "95% Vaccinated" }
			],
			"on": [
				{"trigger": "clicked", "toggle": "clicked"}
			]
		},
		{
			"name": "main",
			"format": {"type": "csv", "parse": "auto"},
			"url": "/posts/pandemic-trade-offs-august-2021/data-ABM-v2.csv",
			"transform": [
				{ "type": "filter", "expr": "datum.str === Strategy" },
				{ "type": "filter", "expr": "datum.va === VaccArrivals" },
				{ "type": "filter", "expr": "datum.vk === VaccKids" },
				{ "type": "filter", "expr": "datum.R0 === R0" },
				{ "type": "filter", "expr": "datum.tp === 'ass100_90at5'" },
				{ "type": "filter", "expr": "datum.ms === MinStage" },
				{ "type": "extent", "field": "q95", "signal": "Extent" },
				
				{"type": "formula", "as": "nq95", "expr": "MaxHeight === 'depend on data' ? datum.q95 : clamp(datum.q95, 0, toNumber(MaxHeight))"},
				{"type": "formula", "as": "nq5", "expr": "MaxHeight === 'depend on data' ? datum.q5 : clamp(datum.q5, 0, toNumber(MaxHeight))"}
			]
		},
		{
			"name": "mainFiltered",
			"source": "main",
			"transform": [
				{ "type": "filter", "expr": "indata('selected', 'value', datum.vu)" }
			]
		},
		{
			"name": "mainByWeek",
			"source": "main",
			"transform": [
				{ "type": "formula", "as": "label", "expr": "toString(datum.q50) + ' (' + toString(datum.q5) + ' to ' + toString(datum.q95) + ')'" },
				{ "type": "formula", "as": "group", "expr": "'group'" },
				{ "type": "pivot", "groupby": ["wk"], "field": "group", "value": "lab", "op": "values" },
				{ "type": "formula", "as": "70% Vaccinated", "expr": "datum.group[0].label" },
				{ "type": "formula", "as": "80% Vaccinated", "expr": "datum.group[1].label" },
				{ "type": "formula", "as": "90% Vaccinated", "expr": "datum.group[2].label" },
				{ "type": "formula", "as": "95% Vaccinated", "expr": "datum.group[3].label" }
			]
		},
		{
			"name": "rules",
			"values": [
				{ "phase": "Borders open", "startDay": 210 }
			]
		},
		{
			"name": "annotations",
			"values": [
				{ "x": 25, "y": 80, "x2": 40, "y2": 49.5, "text": ["Solid lines show the", "median number of new", "infections each day"], "align": "right", "baseline": "bottom"},
				{ "x": 25, "y": 150, "x2": 36, "y2": 150, "text": ["Shaded bands are 90%", "uncertainty intervals"], "align": "right", "baseline": "bottom"},
				{ "x": 5, "y": 50, "x2": 0.5, "y2": 0, "text": ["All simulations start", "with a 2.25% probability", "of a new infection arising", "each day"], "align": "left", "baseline": "bottom"}
			]
		}
	],

	"uom": {
		"minWidth": 900,
		"figPosition": "outset-3",
		"increaseMargin": 2,
		"dataDownload": {
			"href": "/posts/pandemic-trade-offs/data-ABM-aggregated-tidy-v2.csv",
			"size": "Currently unavailable"
		},
		"toggleGroups": [
			{
				"name": "None",
				"toggles": [
					{
						"title": "Strategy",
						"description": "Short, medium, and long term strategies employed to mitigate the spread of COVID-19 <br> (< 4 mths / 4-8 mths / 8+ mths)",
						"detailLink": "/pandemic-trade-offs-detail-august-2021/#strategies",
						"type": "select",
						"options": [
							{ "value": "ME_ME_TS", "label": "Elimination / Elimination / Tight", "default": true },
							{ "value": "ME_TS_LS", "label": "Elimination / Tight / Loose" },
							{ "value": "ME_TS_BS", "label": "Elimination / Tight / Barely Suppress" }
						],
						"signalName": "Strategy"
					},
					{
						"title": "Vaccinated Infected Arrivals per day",
						"description": "Average number of vaccinated yet infected people arriving in Australia per day, after borders open",
						"detailLink": "/pandemic-trade-offs-detail-august-2021/#arrivals",
						"type": "select",
						"options": [
							{ "value": 0.2, "label": "0.2 per day", "default": true },
							{ "value": 1, "label": "1 per day" },
							{ "value": 5, "label": "5 per day" }
						],
						"signalName": "VaccArrivals"
					},
					{
						"title": "Vaccinate Eligibility",
						"description": "Whether to vaccinate adults only (18+ year olds), or to vaccinate adults and children (5+ year olds)",
						"detailLink": "/pandemic-trade-offs-detail-august-2021/#effectiveness",
						"type": "select",
						"options": [
							{ "value": "No", "label": "Adults only"},
							{ "value": "Yes", "label": "Adults and children", "default": true }
						],
						"signalName": "VaccKids"
					},
					{
						"title": "Acceptable range of restriction levels",
						"description": "Whether the suppression policy can use the full range of restriction levels, or has Stage 2 as a minimum level of 'light restrictions'",
						"detailLink": "/pandemic-trade-offs-detail-august-2021/#effectiveness",
						"type": "select",
						"options": [
							{ "value": "1a", "label": "Allow all restriction levels", "default": true },
							{ "value": "2", "label": "Keep a minimum level of light restrictions (Stage 2)"}
						],
						"signalName": "MinStage"
					},
					{
						"title": "Virus Reproduction Rate (R0)",
						"description": "Average number of people each infected person infects with no interventions, such as masks, physical distancing, case isolation, and vaccination.",
						"detailLink": "/pandemic-trade-offs-detail-august-2021/#reproduction",
						"type": "select",
						"options": [
							{ "value": 5, "label": "5.0" },
							{ "value": 6.5, "label": "6.5", "default": true  },
							{ "value": 8.0, "label": "8.0" }
						],
						"signalName": "R0"
					}
				]
			}
		]
	},

	"signals": [
		{
			"name": "clicked", "value": null,
			"on": [
				{
					"events": "@legendSymbol:click, @legendLabel:click",
					"update": "{value: datum.value}",
					"force":  true
				}
			]
		},
		
		{
			"name": "MaxHeight", "value": "depend on data",
			"bind": {
				"input": "select",
				"name": "Set maximum height to",
				"options": ["depend on data", 20, 50, 100, 200, 500, 750, 1000, 2000, 4000, 6500],
				"element": "#graph-settings-ABM-v2"
			}
		},
		{
			"name": "VerticalScale", "value": true,
			"bind": {
				"input": "select",
				"name": "Scale type:",
				"options": [1, 0.45],
				"labels": ["Linear", "Non-Linear"],
				"element": "#graph-settings-ABM-v2"
			}
		},
		{
			"name": "Domain", "value": [0,81],
			"bind": {
				"input": "select",
				"name": "Sample subset:",
				"options": [[0,81], [0,29], [30,81]],
				"labels": ["Full sample", "Before borders open", "After borders open"],
				"element": "#graph-settings-ABM-v2"
			}
		},
		{
			"name": "VerticalScaleBins",
			"update": "VerticalScale == 0.45 ? [0,1,5,10,25,50,100,250,500,1000,2500,5000] : null"
		},

		{
			"name": "hasChanged",
			"init": false,
			"on": [
				{ "events": { "signal": "clicked" }, "update": "true" },
				{ "events": { "signal": "MaxHeight" }, "update": "true" },
				{ "events": { "signal": "VerticalScale" }, "update": "true" },
				{ "events": { "signal": "Domain" }, "update": "true" },
				{ "events": { "source": "#select-ABM-v2-VaccArrivals", "type": "change" }, "update": "true" },
				{ "events": { "source": "#select-ABM-v2-VaccKids", "type": "change" }, "update": "true" },
				{ "events": { "source": "#select-ABM-v2-MinStage", "type": "change" }, "update": "true" },
				{ "events": { "source": "#select-ABM-v2-Strategy", "type": "change" }, "update": "true" },
				{ "events": { "source": "#select-ABM-v2-R0", "type": "change" }, "update": "true" }
			]
		}
	],

	"scales": [
		{
			"name": "x",
			"type": "linear",
			"range": "width",
			"zero": false,
			"domain": {"signal": "Domain"}
		},
		{
			"name": "y",
			"type": "pow",
			"range": "height",
			"domain": { "signal": "MaxHeight === 'depend on data' ? Extent : [0,toNumber(MaxHeight)]" },
			"domainMin": 0,
			"exponent": { "signal": "VerticalScale" },
			"bins": { "signal": "VerticalScaleBins" }
		},
		{
			"name": "colour",
			"type": "ordinal",
			"range": {"scheme": "viridis"},
			"domain": ["70% Vaccinated", "80% Vaccinated", "90% Vaccinated", "95% Vaccinated"]
		},
		{
			"name": "parameters",
			"type": "ordinal",
			"domain": { "signal": "['Strategy: ' + Strategy, 'Infected Arrivals: ' + VaccArrivals, 'Vaccinate Kids: ' + VaccKids, 'Minimum Stage: ' + MinStage, 'R_0: ' + R0]"},
			"range": ["#ffffff", "#ffffff", "#ffffff", "#ffffff", "#ffffff"]
		}
	],

	"legends": [
		{
			"fill": "colour",
			"labelLimit": 200,
			"title": "Strategies",
			"orient":"bottom",
			"encode": {
				"symbols": {
					"name": "legendSymbol",
					"interactive": true,
					"update": {
						"opacity": [
							{"test": "indata('selected', 'value', datum.value)", "value": 1},
							{"value": 0.15}
						],
						"cursor": {"value": "pointer"}
					}
				},
				"labels": {
					"name": "legendLabel",
					"interactive": true,
					"update": {
						"opacity": [
							{"test": "indata('selected', 'value', datum.value)", "value": 1},
							{"value": 0.25}
						],
						"cursor": {"value": "pointer"}
					}
				}
			}
		},
		{
			"fill": "parameters",
			"labelLimit": 200,
			"title": "Parameters",
			"orient":"bottom",
			"titleFontSize": 18,
			"titlePadding": 10,
			"symbolSize": 0,
			"rowPadding": 3,
			"padding": 15,
			"fillColor": "#f2f5f9",
			"cornerRadius": 5,
			"encode": {
				"labels": {
					"enter": {
						"dx": {"value": -24},
						"fontSize": {"value": 14},
						"font": {"value": "monospace"}
					}
				}
			}
		}
	],

	"axes": [
		{
			"orient": "bottom",
			"scale": "x",
			"title": "Weeks since start of simulation",
			"titleY": 50,
			"zindex": 100
		},
		{
			"orient": "left",
			"scale": "y",
			"title": "New infections each day (median 7-day average)",
			"titleX": -50,
			"zindex": 100
		}
	],

	"marks": [
		{
			"type": "rule",
			"clip": true,
			"from": { "data": "rules" },
			"encode": {
				"update": {
					"x": {"scale": "x", "signal": "datum.startDay / 7"},
					"x2": {"scale": "x", "signal": "datum.startDay / 7"},
					"y": {"scale": "y", "value": 0},
					"y2": {"signal": "range('y')[1]"},
					"strokeOpacity": {"signal": "datum.startDay > 0 ? .1 : 0"},
					"strokeWidth": {"value": 1},
					"stroke": {"value": "#012a58"}
				}
			}
		},
		{
			"type": "group",
			"clip": true,
			"from": {
				"facet": {
					"name": "series",
					"data": "mainFiltered",
					"groupby": ["vu"]
				}
			},
			"marks": [
				{
					"type": "area",
					"from": {"data": "series"},
					"zindex": 0,
					"encode": {
						"update": {
							"x": {"scale": "x", "field": "wk"},
							"y": {"scale": "y", "field": "nq5"},
							"y2": {"scale": "y", "field": "nq95"},
							"fill": {"scale": "colour", "field": "vu"},
							"fillOpacity": {"value": 0.2},
							"strokeWidth": {"value": 0}
						}
					}
				},
				{
					"type": "line",
					"from": {"data": "series"},
					"zindex": 1,
					"encode": {
						"update": {
							"x": {"scale": "x", "field": "wk"},
							"y": {"scale": "y", "field": "q50"},
							"stroke": {"scale": "colour", "field": "vu"},
							"strokeWidth": {"value": 2},
							"defined": { "signal": "datum.q50 < domain('y')[1]" }
						}
					}
				}
			]
		},
		{
			"type": "rect",
			"from": { "data": "mainByWeek" },
			"encode": {
				"update": {
					"x": {"scale": "x", "signal": "datum.wk - 0.5"},
					"x2": {"scale": "x", "signal": "datum.wk + 0.5"},
					"y": {"scale": "y", "value": 0},
					"y2": {"signal": "range('y')[1]"},
					"strokeWidth": {"value": 0},
					"fill": {"value": "#999999"},
					"fillOpacity": {"value": 0},
					"tooltip": { "signal": "{ 'title': 'Week ' + datum.wk, '70% Vaccinated': datum['70% Vaccinated'], '80% Vaccinated': datum['80% Vaccinated'], '90% Vaccinated': datum['90% Vaccinated'], '95% Vaccinated': datum['95% Vaccinated']}"}
				},
				"hover": {
					"fillOpacity": {"value": 0.2}
				}
			}
		},
		{	
			"name": "phases",
			"type": "text",
			"clip": true,
			"from": { "data": "rules" },
			"encode": {
				"update": {
					"x": {"scale": "x", "signal": "datum.startDay / 7"},
					"y": {"signal": "range('y')[1]"},
					"text": {"signal": "'Borders Open'"},
					"baseline": {"value": "top"},
					"dx": {"value": 5},
					"fill": {"value": "#012a58"},
					"href": {"value": "/pandemic-trade-offs-detail#phases"},
					"cursor": {"value": "pointer"}
				}
			},
			"zindex": 1
		},
		{
			"type": "rect",
			"from": {"data": "phases"},
			"clip": true,
			"encode": {
				"update": {
					"x": {"field": "bounds.x1", "round": true, "offset": {"value": -3}},
					"x2": {"field": "bounds.x2", "round": true, "offset": {"value": 3}},
					"y": {"field": "bounds.y1", "round": true, "offset": {"value": -3}},
					"y2": {"field": "bounds.y2", "round": true, "offset": {"value": 3}},
					"fill": {"value": "#f0f0f0"},
					"fillOpacity": {"value": 0.8}
				}
			}
		},
		{
			"name": "timestamp",
			"type": "text",
			"encode": {
			  "enter": {
				"x": {"signal": "range('x')[1] - 3"},
				"y": {"signal": "range('y')[1] + 3"},
				"fill": {"value": "#012a58"},
				"text": {"value": "Updated: 03 Sep 2021"},
				"align": {"value": "right"},
				"baseline": {"value": "top"}
			  }
			},
			"zindex": 1
		},
		{
			"name": "rectmark",
			"type": "rect",
			"from": {"data": "timestamp"},
			"encode": {
				"enter": {
					"x": {"field": "bounds.x1", "round": true, "offset": {"value": -3}},
					"x2": {"field": "bounds.x2", "round": true, "offset": {"value": 3}},
					"y": {"field": "bounds.y1", "round": true, "offset": {"value": -3}},
					"y2": {"field": "bounds.y2", "round": true, "offset": {"value": 3}},
					"fill": {"value": "#f0f0f0"},
					"fillOpacity": {"value": 0.8}
				}
			}
		},
		{
			"type": "rule",
			"from": { "data": "annotations" },
			"clip": true,
			"encode": {
				"update": {
					"x": {"scale": "x", "field": "x"},
					"y": {"scale": "y", "field": "y"},
					"x2": {"scale": "x", "field": "x2"},
					"y2": {"scale": "y", "field": "y2"},
					"strokeWidth": { "value": 0.5 },
					"strokeWidth": {"signal": "hasChanged > 0 ? 0 : 0.5"}
				}
			}
		},
		{
			"type": "text",
			"from": { "data": "annotations" },
			"clip": true,
			"encode": {
				"update": {
					"x": {"scale": "x", "field": "x"},
					"y": {"scale": "y", "field": "y"},
					"text": {"signal": "datum.text"},
					"fillOpacity": {"value": 1},
					"align": {"signal": "datum.align"},
					"baseline": {"signal": "datum.baseline"},
					"dx": {"signal": "datum.align == 'left' ? 5 : -5"},
					"fillOpacity": {"signal": "hasChanged > 0 ? 0 : 1"}
				}
			}
		}
	]
}
